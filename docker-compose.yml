version: "3.9"

services:
  web:
    build: .
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - letsencrypt:/etc/letsencrypt:ro
      - letsencrypt-var:/var/lib/letsencrypt
      - certbot-www:/var/www/certbot:ro
    environment:
      - DOMAIN=dswsolutions.io

  # Nginx temporal solo para el ACME challenge (primera vez)
  web-init:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx-init.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-www:/var/www/certbot:ro
    profiles:
      - certbot

  # Servicio certbot para obtener/renovar certificados
  certbot:
    image: certbot/certbot:latest
    volumes:
      - letsencrypt:/etc/letsencrypt
      - letsencrypt-var:/var/lib/letsencrypt
      - certbot-www:/var/www/certbot
    profiles:
      - certbot
    command: >-
      certonly --webroot
      -w /var/www/certbot
      -d dswsolutions.io
      -d www.dswsolutions.io
      --email ${CERTBOT_EMAIL:-admin@dswsolutions.io}
      --agree-tos
      --non-interactive

volumes:
  letsencrypt:
  letsencrypt-var:
  certbot-www:
